<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记忆助手 - 自定义分类备忘录</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#EC4899',
                        neutral: {
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            300: '#D1D5DB',
                            800: '#1F2937',
                            900: '#111827'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .memo-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .memo-hover {
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .memo-hover:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            }
            .password-masked {
                letter-spacing: 0.2em;
            }
            /* 删除按钮样式 - 确保可点击区域足够大 */
            .memo-delete-btn {
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                cursor: pointer;
                z-index: 10;
                position: relative;
            }
            .memo-delete-btn:hover {
                animation: pulse 1s infinite;
                background-color: rgba(239, 68, 68, 0.1);
                color: #ef4444;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
            /* 选中状态样式 */
            .memo-selected {
                border-color: #4F46E5 !important;
                background-color: rgba(79, 70, 229, 0.03) !important;
            }
            .batch-actions {
                transform: translateY(-10px);
                opacity: 0;
                transition: all 0.3s ease;
            }
            .batch-actions.active {
                transform: translateY(0);
                opacity: 1;
            }
            /* 呼吸效果动画 - 用于删除按钮强调 */
            @keyframes breathing {
                0% { background-color: #ef4444; }
                50% { background-color: #f87171; }
                100% { background-color: #ef4444; }
            }
            .editing-breathing-bg {
                animation: breathing 1.5s infinite ease-in-out;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-neutral-800 min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fa fa-brain text-primary text-3xl mr-3"></i>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary text-transparent bg-clip-text">记忆助手</h1>
            </div>
            
            <div class="w-full md:w-auto flex flex-col md:flex-row gap-3">
                <div class="relative w-full md:w-64">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="搜索记录..." 
                        class="w-full pl-10 pr-4 py-2 rounded-lg border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                    >
                    <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"></i>
                </div>
                
                <div class="flex gap-3">
                    <!-- 批量操作按钮组 -->
                    <div id="batch-actions" class="batch-actions hidden md:flex gap-2">
                        <button 
                            id="select-all-btn" 
                            class="bg-white border border-neutral-300 text-neutral-700 hover:bg-neutral-50 px-3 py-2 rounded-lg flex items-center justify-center gap-1 transition-all"
                        >
                            <i class="fa fa-check-square-o"></i>
                            <span class="hidden sm:inline">全选</span>
                        </button>
                        <button 
                            id="deselect-all-btn" 
                            class="bg-white border border-neutral-300 text-neutral-700 hover:bg-neutral-50 px-3 py-2 rounded-lg flex items-center justify-center gap-1 transition-all"
                        >
                            <i class="fa fa-square-o"></i>
                            <span class="hidden sm:inline">取消</span>
                        </button>
                        <button 
                            id="delete-selected-btn" 
                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-1 transition-all"
                        >
                            <i class="fa fa-trash"></i>
                            <span class="hidden sm:inline editing-breathing-bg">删除所选</span>
                        </button>
                    </div>
                    
                    <button 
                        id="manage-categories-btn" 
                        class="bg-white border border-neutral-300 text-neutral-700 hover:bg-neutral-50 px-4 py-2 rounded-lg flex items-center justify-center gap-2 transition-all"
                    >
                        <i class="fa fa-tags"></i>
                        <span class="hidden sm:inline">分类管理</span>
                    </button>
                    
                    <button 
                        id="add-memo-btn" 
                        class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 transition-all transform hover:scale-105 active:scale-95 shadow-md hover:shadow-lg"
                    >
                        <i class="fa fa-plus"></i>
                        <span>新增记录</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- 分类筛选 -->
        <div class="mb-8 overflow-x-auto pb-2">
            <div class="flex gap-2 min-w-max" id="category-filters">
                <!-- 分类筛选按钮将通过JavaScript动态生成 -->
            </div>
        </div>
        
        <!-- 备忘录统计 -->
        <div class="mb-8">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-neutral-100 max-w-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-neutral-500 text-sm">待处理项</p>
                        <p class="text-2xl font-bold mt-1" id="pending-memos">0</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-secondary/10 flex items-center justify-center text-secondary">
                        <i class="fa fa-list-alt text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 备忘录列表 -->
        <div id="memo-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- 备忘录将通过JavaScript动态添加 -->
            <div class="col-span-full flex flex-col items-center justify-center py-16 text-neutral-500">
                <i class="fa fa-sticky-note-o text-6xl mb-4 opacity-30"></i>
                <p class="text-xl mb-2">还没有记录</p>
                <p class="text-center max-w-md">点击"新增记录"按钮开始添加你的第一条记录</p>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-neutral-200 py-6">
        <div class="container mx-auto px-4 text-center text-neutral-500 text-sm">
            <p>© 2023 记忆助手 - 个人记录好帮手</p>
            <p class="mt-1">安全记录生活中的重要信息</p>
        </div>
    </footer>

    <!-- 新建/编辑备忘录模态框 -->
    <div id="memo-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="p-6 border-b border-neutral-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h2 id="modal-title" class="text-xl font-bold">新增记录</h2>
                <button id="close-modal" class="text-neutral-500 hover:text-neutral-800 transition-colors">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6">
                <form id="memo-form">
                    <input type="hidden" id="memo-id">
                    
                    <div class="mb-4">
                        <label for="memo-title-input" class="block text-sm font-medium text-neutral-700 mb-1">标题</label>
                        <input 
                            type="text" 
                            id="memo-title-input" 
                            class="w-full px-4 py-2 rounded-lg border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                            placeholder="输入记录标题..."
                            required
                        >
                    </div>
                    
                    <div class="mb-4">
                        <label for="memo-category" class="block text-sm font-medium text-neutral-700 mb-1">分类</label>
                        <select 
                            id="memo-category" 
                            class="w-full px-4 py-2 rounded-lg border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                        >
                            <!-- 分类选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="memo-content" class="block text-sm font-medium text-neutral-700 mb-1">内容</label>
                        <textarea 
                            id="memo-content" 
                            rows="6" 
                            class="w-full px-4 py-2 rounded-lg border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none"
                            placeholder="输入详细内容..."
                        ></textarea>
                    </div>
                    
                    <div class="flex items-center mb-6" id="completed-section">
                        <input 
                            type="checkbox" 
                            id="memo-completed" 
                            class="w-4 h-4 text-primary border-neutral-300 rounded focus:ring-primary"
                        >
                        <label for="memo-completed" class="ml-2 block text-sm text-neutral-700" id="completed-label">标记为已完成</label>
                    </div>
                    
                    <div class="flex justify-end gap-3">
                        <button 
                            type="button" 
                            id="cancel-btn" 
                            class="px-4 py-2 border border-neutral-300 rounded-lg text-neutral-700 hover:bg-neutral-50 transition-colors"
                        >
                            取消
                        </button>
                        <button 
                            type="button" 
                            id="save-btn" 
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors shadow-sm hover:shadow"
                        >
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 分类管理模态框 -->
    <div id="category-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-xl max-h-[90vh] overflow-auto transform scale-95 transition-transform duration-300" id="category-modal-content">
            <div class="p-6 border-b border-neutral-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h2 class="text-xl font-bold">分类管理</h2>
                <button id="close-category-modal" class="text-neutral-500 hover:text-neutral-800 transition-colors">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">添加新分类</h3>
                    <form id="add-category-form">
                        <input 
                            type="text" 
                            id="new-category-name" 
                            placeholder="分类名称" 
                            class="flex-grow px-4 py-2 rounded-lg border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                            required
                        >
                        <select 
                            id="new-category-color" 
                            class="px-4 py-2 rounded-lg border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                        >
                            <option value="bg-red-100 text-red-600">红色</option>
                            <option value="bg-orange-100 text-orange-600">橙色</option>
                            <option value="bg-yellow-100 text-yellow-600">黄色</option>
                            <option value="bg-green-100 text-green-600">绿色</option>
                            <option value="bg-blue-100 text-blue-600">蓝色</option>
                            <option value="bg-purple-100 text-purple-600">紫色</option>
                            <option value="bg-pink-100 text-pink-600">粉色</option>
                            <option value="bg-gray-100 text-gray-600">灰色</option>
                        </select>
                        <button 
                            type="button" 
                            id="add-category-btn" 
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                        >
                            <i class="fa fa-plus"></i>
                        </button>
                    </form>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-3">现有分类</h3>
                    <div id="categories-list" class="space-y-2">
                        <!-- 分类列表将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局应用实例
        let app;
        
        // 分类数据模型
        class Category {
            constructor(id, name, colorClass, icon = 'fa-flag') {
                this.id = id || Date.now().toString();
                this.name = name;
                this.colorClass = colorClass;
                this.icon = icon;
            }
        }

        // 备忘录数据模型
        class Memo {
            constructor(id, title, content, categoryId, completed, createdAt) {
                this.id = id || Date.now().toString();
                this.title = title;
                this.content = content;
                this.categoryId = categoryId;
                this.completed = completed || false;
                this.createdAt = createdAt || new Date().toISOString();
            }
        }

        // 数据存储管理
        class DataStorage {
            // 分类相关方法
            static getCategories() {
                const categories = localStorage.getItem('memoCategories');
                if (!categories || JSON.parse(categories).length === 0) {
                    // 默认分类
                    const defaultCategories = [
                        new Category('1', '账号密码', 'bg-yellow-100 text-yellow-600', 'fa-key'),
                        new Category('2', '影视娱乐', 'bg-purple-100 text-purple-600', 'fa-film'),
                        new Category('3', '阅读清单', 'bg-green-100 text-green-600', 'fa-book'),
                        new Category('4', '生活琐事', 'bg-blue-100 text-blue-600', 'fa-home')
                    ];
                    this.saveCategories(defaultCategories);
                    return defaultCategories;
                }
                return JSON.parse(categories).map(cat => new Category(
                    cat.id,
                    cat.name,
                    cat.colorClass,
                    cat.icon
                ));
            }

            static saveCategory(category) {
                const categories = this.getCategories();
                const index = categories.findIndex(c => c.id === category.id);
                
                if (index >= 0) {
                    categories[index] = category;
                } else {
                    categories.push(category);
                }
                
                this.saveCategories(categories);
                return category;
            }

            static saveCategories(categories) {
                localStorage.setItem('memoCategories', JSON.stringify(categories));
            }

            static deleteCategory(id) {
                let categories = this.getCategories();
                categories = categories.filter(cat => cat.id !== id);
                this.saveCategories(categories);
                
                // 同时更新使用该分类的备忘录为未分类
                let memos = this.getMemos();
                memos.forEach(memo => {
                    if (memo.categoryId === id) {
                        memo.categoryId = null;
                    }
                });
                this.saveMemos(memos);
            }

            static getCategory(id) {
                return this.getCategories().find(cat => cat.id === id) || null;
            }

            // 备忘录相关方法
            static getMemos() {
                const memos = localStorage.getItem('memos');
                return memos ? JSON.parse(memos).map(memo => new Memo(
                    memo.id,
                    memo.title,
                    memo.content,
                    memo.categoryId,
                    memo.completed,
                    memo.createdAt
                )) : [];
            }

            static saveMemo(memo) {
                const memos = this.getMemos();
                const index = memos.findIndex(m => m.id === memo.id);
                
                if (index >= 0) {
                    memos[index] = memo;
                } else {
                    memos.push(memo);
                }
                
                this.saveMemos(memos);
                return memo;
            }

            static saveMemos(memos) {
                localStorage.setItem('memos', JSON.stringify(memos));
            }

            static deleteMemo(id) {
                let memos = this.getMemos();
                // 过滤掉要删除的备忘录
                const updatedMemos = memos.filter(memo => memo.id !== id);
                this.saveMemos(updatedMemos);
                return updatedMemos; // 返回更新后的列表
            }

            // 批量删除备忘录
            static deleteMemos(ids) {
                let memos = this.getMemos();
                // 过滤掉要删除的备忘录
                const updatedMemos = memos.filter(memo => !ids.includes(memo.id));
                this.saveMemos(updatedMemos);
                return updatedMemos; // 返回更新后的列表
            }

            // 统计相关方法
            static getCategoryMemosCount(categoryId) {
                return this.getMemos().filter(memo => memo.categoryId === categoryId).length;
            }

            static getPendingMemosCount() {
                return this.getMemos().filter(memo => !memo.completed).length;
            }
        }

        // 备忘录UI控制器
        class MemoUI {
            constructor() {
                console.log('初始化应用程序');
                
                // 状态变量
                this.currentCategory = 'all';
                this.searchTerm = '';
                this.isPasswordVisible = false;
                this.selectedMemos = new Set(); // 存储选中的备忘录ID
                
                // 初始化
                this.initElements();
                this.setupEventListeners();
                this.renderCategories();
                this.renderMemos();
                this.updateStats();
            }

            // 初始化DOM元素引用
            initElements() {
                console.log('初始化DOM元素');
                // 存储元素引用
                this.elements = {
                    memoList: document.getElementById('memo-list'),
                    categoryFilters: document.getElementById('category-filters'),
                    memoModal: document.getElementById('memo-modal'),
                    modalContent: document.getElementById('modal-content'),
                    memoForm: document.getElementById('memo-form'),
                    memoId: document.getElementById('memo-id'),
                    memoTitleInput: document.getElementById('memo-title-input'),
                    memoContent: document.getElementById('memo-content'),
                    memoCategory: document.getElementById('memo-category'),
                    memoCompleted: document.getElementById('memo-completed'),
                    modalTitle: document.getElementById('modal-title'),
                    closeModal: document.getElementById('close-modal'),
                    cancelBtn: document.getElementById('cancel-btn'),
                    saveBtn: document.getElementById('save-btn'),
                    categoryModal: document.getElementById('category-modal'),
                    categoryModalContent: document.getElementById('category-modal-content'),
                    closeCategoryModal: document.getElementById('close-category-modal'),
                    addCategoryForm: document.getElementById('add-category-form'),
                    newCategoryName: document.getElementById('new-category-name'),
                    newCategoryColor: document.getElementById('new-category-color'),
                    addCategoryBtn: document.getElementById('add-category-btn'),
                    categoriesList: document.getElementById('categories-list'),
                    pendingMemos: document.getElementById('pending-memos'),
                    searchInput: document.getElementById('search-input'),
                    manageCategoriesBtn: document.getElementById('manage-categories-btn'),
                    addMemoBtn: document.getElementById('add-memo-btn'),
                    navbar: document.getElementById('navbar'),
                    // 批量操作元素
                    batchActions: document.getElementById('batch-actions'),
                    selectAllBtn: document.getElementById('select-all-btn'),
                    deselectAllBtn: document.getElementById('deselect-all-btn'),
                    deleteSelectedBtn: document.getElementById('delete-selected-btn')
                };
            }
            
            // 设置所有事件监听器
            setupEventListeners() {
                console.log('设置事件监听器');
                
                // 导航栏滚动效果
                window.addEventListener('scroll', () => this.handleScroll());
                
                // 搜索功能
                this.elements.searchInput.addEventListener('input', (e) => {
                    this.searchTerm = e.target.value.toLowerCase();
                    this.renderMemos();
                });
                
                // 顶部按钮
                this.elements.addMemoBtn.addEventListener('click', () => this.openModal());
                this.elements.manageCategoriesBtn.addEventListener('click', () => this.openCategoryModal());
                
                // 批量操作按钮 - 使用箭头函数确保this指向正确
                this.elements.selectAllBtn.addEventListener('click', () => this.selectAllMemos());
                this.elements.deselectAllBtn.addEventListener('click', () => this.deselectAllMemos());
                this.elements.deleteSelectedBtn.addEventListener('click', () => {
                    console.log('删除所选按钮被点击');
                    this.deleteSelectedMemos();
                });
                
                // 备忘录模态框
                this.elements.closeModal.addEventListener('click', () => this.closeModalFunc());
                this.elements.cancelBtn.addEventListener('click', () => this.closeModalFunc());
                this.elements.saveBtn.addEventListener('click', () => this.saveMemo());
                
                // 分类模态框
                this.elements.closeCategoryModal.addEventListener('click', () => this.closeCategoryModalFunc());
                this.elements.addCategoryBtn.addEventListener('click', () => this.addNewCategory());
                
                // 点击模态框外部关闭
                this.elements.memoModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.memoModal) {
                        this.closeModalFunc();
                    }
                });
                
                this.elements.categoryModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.categoryModal) {
                        this.closeCategoryModalFunc();
                    }
                });
                
                // 为删除按钮添加专用事件监听
                this.elements.memoList.addEventListener('click', this.handleDeleteClick.bind(this));
                
                // 备忘录项点击事件（用于选择/取消选择）
                this.elements.memoList.addEventListener('click', this.handleMemoClick.bind(this));
                
                // 其他备忘录列表点击事件
                this.elements.memoList.addEventListener('click', this.handleOtherMemoClicks.bind(this));
                
                this.elements.categoriesList.addEventListener('click', (e) => this.handleCategoriesListClick(e));
                this.elements.categoryFilters.addEventListener('click', (e) => this.handleCategoryFilterClick(e));
                
                // 确保批量操作按钮在DOM加载后可用
                setTimeout(() => {
                    if (this.elements.deleteSelectedBtn) {
                        console.log('删除所选按钮已加载');
                    } else {
                        console.error('删除所选按钮未找到');
                    }
                }, 1000);
            }
            
            // 处理备忘录点击事件（用于选择/取消选择）
            handleMemoClick(e) {
                // 如果点击的是操作按钮，不触发选择
                if (e.target.closest('.edit-btn, .memo-delete-btn, .show-hide-btn, .complete-checkbox')) {
                    return;
                }
                
                const memoElement = e.target.closest('[data-id]');
                if (memoElement) {
                    const memoId = memoElement.dataset.id;
                    this.toggleMemoSelection(memoId);
                }
            }
            
            // 切换备忘录选择状态
            toggleMemoSelection(memoId) {
                if (this.selectedMemos.has(memoId)) {
                    this.selectedMemos.delete(memoId);
                } else {
                    this.selectedMemos.add(memoId);
                }
                
                this.updateMemoSelectionUI();
                this.updateBatchActionsVisibility();
            }
            
            // 全选备忘录
            selectAllMemos() {
                const visibleMemos = this.elements.memoList.querySelectorAll('[data-id]');
                visibleMemos.forEach(memo => {
                    this.selectedMemos.add(memo.dataset.id);
                });
                
                this.updateMemoSelectionUI();
                this.updateBatchActionsVisibility();
            }
            
            // 取消全选
            deselectAllMemos() {
                this.selectedMemos.clear();
                this.updateMemoSelectionUI();
                this.updateBatchActionsVisibility();
            }
            
            // 更新备忘录选择UI
            updateMemoSelectionUI() {
                // 移除所有选中状态
                document.querySelectorAll('[data-id]').forEach(memo => {
                    memo.classList.remove('memo-selected');
                });
                
                // 添加选中状态
                this.selectedMemos.forEach(id => {
                    const memoElement = document.querySelector(`[data-id="${id}"]`);
                    if (memoElement) {
                        memoElement.classList.add('memo-selected');
                    }
                });
                
                // 更新批量删除按钮文本
                if (this.selectedMemos.size > 0) {
                    this.elements.deleteSelectedBtn.innerHTML = `<i class="fa fa-trash"></i>
                        <span class="hidden sm:inline editing-breathing-bg">删除所选(${this.selectedMemos.size})</span>`;
                } else {
                    this.elements.deleteSelectedBtn.innerHTML = `<i class="fa fa-trash"></i>
                        <span class="hidden sm:inline editing-breathing-bg">删除所选</span>`;
                }
            }
            
            // 更新批量操作按钮可见性
            updateBatchActionsVisibility() {
                if (this.selectedMemos.size > 0) {
                    this.elements.batchActions.classList.remove('hidden');
                    this.elements.batchActions.classList.add('active');
                    // 确保删除按钮获得焦点状态
                    this.elements.deleteSelectedBtn.classList.add('ring-2', 'ring-red-300');
                    setTimeout(() => {
                        this.elements.deleteSelectedBtn.classList.remove('ring-2', 'ring-red-300');
                    }, 300);
                } else {
                    this.elements.batchActions.classList.remove('active');
                    // 小延迟后隐藏，让动画完成
                    setTimeout(() => {
                        if (this.selectedMemos.size === 0) {
                            this.elements.batchActions.classList.add('hidden');
                        }
                    }, 300);
                }
            }
            
            // 批量删除选中的备忘录
            deleteSelectedMemos() {
                if (this.selectedMemos.size === 0) {
                    console.log('没有选中的备忘录');
                    return;
                }
                
                const count = this.selectedMemos.size;
                if (confirm(`确定要删除这${count}条记录吗？此操作不可撤销。`)) {
                    try {
                        // 调用数据存储层批量删除
                        const ids = Array.from(this.selectedMemos);
                        const updatedMemos = DataStorage.deleteMemos(ids);
                        console.log(`批量删除${count}条记录，剩余记录数:`, updatedMemos.length);
                        
                        // 清空选择
                        this.selectedMemos.clear();
                        
                        // 重新渲染列表
                        this.renderMemos();
                        this.renderCategories(); // 更新分类计数
                        this.updateBatchActionsVisibility();
                        
                        this.showToast(`成功删除${count}条记录`);
                    } catch (error) {
                        console.error('批量删除失败:', error);
                        this.showToast('删除失败，请重试', 'error');
                    }
                }
            }
            
            // 专门处理删除按钮点击的函数
            handleDeleteClick(e) {
                // 只处理删除按钮的点击
                const deleteBtn = e.target.closest('.memo-delete-btn');
                if (deleteBtn) {
                    e.stopPropagation(); // 阻止事件冒泡
                    
                    // 获取备忘录ID
                    const memoId = deleteBtn.getAttribute('data-memo-id');
                    console.log('检测到删除按钮点击，ID:', memoId);
                    
                    if (memoId) {
                        this.deleteMemo(memoId);
                    } else {
                        console.error('未找到备忘录ID');
                        this.showToast('删除失败：未找到记录ID', 'error');
                    }
                }
            }
            
            // 处理其他备忘录相关点击
            handleOtherMemoClicks(e) {
                // 如果点击的是删除按钮，不处理
                if (e.target.closest('.memo-delete-btn')) {
                    return;
                }
                
                const editBtn = e.target.closest('.edit-btn');
                const completeCheckbox = e.target.closest('.complete-checkbox');
                const showHideBtn = e.target.closest('.show-hide-btn');
                
                if (editBtn) {
                    e.stopPropagation();
                    const memoId = editBtn.closest('[data-id]').dataset.id;
                    this.openModal(memoId);
                    return;
                }
                
                if (completeCheckbox) {
                    e.stopPropagation();
                    const memoId = completeCheckbox.closest('[data-id]').dataset.id;
                    this.toggleComplete(memoId, completeCheckbox.checked);
                    return;
                }
                
                if (showHideBtn) {
                    e.stopPropagation();
                    const contentElement = showHideBtn.closest('div').querySelector('.password-content');
                    if (showHideBtn.textContent === '显示') {
                        const memoId = showHideBtn.closest('[data-id]').dataset.id;
                        const memo = DataStorage.getMemos().find(m => m.id === memoId);
                        contentElement.textContent = memo.content;
                        contentElement.classList.remove('password-masked');
                        showHideBtn.textContent = '隐藏';
                    } else {
                        contentElement.textContent = '••••••••';
                        contentElement.classList.add('password-masked');
                        showHideBtn.textContent = '显示';
                    }
                    return;
                }
            }
            
            // 处理滚动事件
            handleScroll() {
                if (window.scrollY > 10) {
                    this.elements.navbar.classList.add('py-2', 'shadow');
                    this.elements.navbar.classList.remove('py-4');
                } else {
                    this.elements.navbar.classList.add('py-4');
                    this.elements.navbar.classList.remove('py-2', 'shadow');
                }
            }
            
            // 处理分类列表点击事件（事件委托）
            handleCategoriesListClick(e) {
                const editBtn = e.target.closest('.edit-category');
                const deleteBtn = e.target.closest('.delete-category');
                
                if (editBtn) {
                    const categoryId = editBtn.dataset.id;
                    this.editCategory(categoryId);
                    return;
                }
                
                if (deleteBtn) {
                    const categoryId = deleteBtn.dataset.id;
                    this.deleteCategory(categoryId);
                    return;
                }
            }
            
            // 处理分类筛选点击事件（事件委托）
            handleCategoryFilterClick(e) {
                const categoryBtn = e.target.closest('.category-btn');
                if (categoryBtn && categoryBtn.dataset.category) {
                    // 切换分类时清空选择
                    this.selectedMemos.clear();
                    this.updateBatchActionsVisibility();
                    
                    this.filterByCategory(categoryBtn.dataset.category);
                }
            }
            
            // 渲染分类相关UI
            renderCategories() {
                console.log('渲染分类');
                const categories = DataStorage.getCategories();
                
                // 渲染分类筛选按钮
                this.elements.categoryFilters.innerHTML = '';
                
                // 添加"全部"筛选按钮
                const allBtn = document.createElement('button');
                allBtn.className = `category-btn ${this.currentCategory === 'all' ? 'bg-primary text-white' : 'bg-white text-neutral-800 hover:bg-neutral-100'} px-4 py-2 rounded-full text-sm font-medium transition-colors`;
                allBtn.dataset.category = 'all';
                allBtn.textContent = '全部';
                this.elements.categoryFilters.appendChild(allBtn);
                
                // 添加"未分类"筛选按钮
                const uncategorizedBtn = document.createElement('button');
                uncategorizedBtn.className = `category-btn ${this.currentCategory === 'uncategorized' ? 'bg-primary text-white' : 'bg-white text-neutral-800 hover:bg-neutral-100'} px-4 py-2 rounded-full text-sm font-medium transition-colors`;
                uncategorizedBtn.dataset.category = 'uncategorized';
                uncategorizedBtn.innerHTML = '<i class="fa fa-question-circle mr-1"></i>未分类';
                this.elements.categoryFilters.appendChild(uncategorizedBtn);
                
                // 添加各个分类的筛选按钮
                categories.forEach(category => {
                    const btn = document.createElement('button');
                    btn.className = `category-btn ${this.currentCategory === category.id ? 'bg-primary text-white' : 'bg-white text-neutral-800 hover:bg-neutral-100'} px-4 py-2 rounded-full text-sm font-medium transition-colors`;
                    btn.dataset.category = category.id;
                    btn.innerHTML = `<i class="fa ${category.icon} mr-1"></i>${category.name}`;
                    this.elements.categoryFilters.appendChild(btn);
                });
                
                // 更新分类选择下拉框
                this.elements.memoCategory.innerHTML = '';
                
                // 添加未分类选项
                const uncategorizedOption = document.createElement('option');
                uncategorizedOption.value = '';
                uncategorizedOption.textContent = '未分类';
                this.elements.memoCategory.appendChild(uncategorizedOption);
                
                // 添加各个分类选项
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    this.elements.memoCategory.appendChild(option);
                });
                
                // 渲染分类管理列表
                this.elements.categoriesList.innerHTML = '';
                categories.forEach(category => {
                    const memoCount = DataStorage.getCategoryMemosCount(category.id);
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-white p-3 rounded-lg border border-neutral-100';
                    div.innerHTML = `
                        <div class="flex items-center">
                            <span class="w-6 h-6 rounded-full ${category.colorClass} flex items-center justify-center text-xs mr-2">
                                <i class="fa ${category.icon}"></i>
                            </span>
                            <span class="font-medium">${category.name}</span>
                            <span class="ml-2 text-xs text-neutral-500">(${memoCount}条记录)</span>
                        </div>
                        <div class="flex gap-1">
                            <button class="edit-category p-1.5 text-neutral-500 hover:text-primary rounded-full hover:bg-primary/10 transition-colors" data-id="${category.id}">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="delete-category p-1.5 text-neutral-500 hover:text-red-500 rounded-full hover:bg-red-100 transition-colors" data-id="${category.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    this.elements.categoriesList.appendChild(div);
                });
                
                // 更新统计
                this.updateStats();
            }
            
            // 按分类筛选备忘录
            filterByCategory(categoryId) {
                console.log('筛选分类:', categoryId);
                this.currentCategory = categoryId;
                
                // 更新按钮样式
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.dataset.category === this.currentCategory) {
                        btn.classList.remove('bg-white', 'text-neutral-800', 'hover:bg-neutral-100');
                        btn.classList.add('bg-primary', 'text-white');
                    } else {
                        btn.classList.remove('bg-primary', 'text-white');
                        btn.classList.add('bg-white', 'text-neutral-800', 'hover:bg-neutral-100');
                    }
                });
                
                this.renderMemos();
            }
            
            // 添加新分类
            addNewCategory() {
                console.log('添加新分类');
                const name = this.elements.newCategoryName.value.trim();
                const colorClass = this.elements.newCategoryColor.value;
                
                if (name) {
                    const category = new Category(null, name, colorClass);
                    DataStorage.saveCategory(category);
                    
                    // 重置表单
                    this.elements.newCategoryName.value = '';
                    
                    // 重新渲染分类
                    this.renderCategories();
                    
                    // 显示提示
                    this.showToast('分类添加成功');
                }
            }
            
            // 编辑分类
            editCategory(id) {
                console.log('编辑分类:', id);
                const category = DataStorage.getCategory(id);
                if (!category) return;
                
                const newName = prompt('请输入新的分类名称:', category.name);
                if (newName !== null && newName.trim() !== '') {
                    category.name = newName.trim();
                    DataStorage.saveCategory(category);
                    this.renderCategories();
                    this.showToast('分类已更新');
                }
            }
            
            // 删除分类
            deleteCategory(id) {
                console.log('删除分类:', id);
                const category = DataStorage.getCategory(id);
                if (!category) return;
                
                const memoCount = DataStorage.getCategoryMemosCount(id);
                let confirmMessage = `确定要删除分类"${category.name}"吗？`;
                
                if (memoCount > 0) {
                    confirmMessage += `\n该分类下有${memoCount}条记录，它们将被标记为未分类。`;
                }
                
                if (confirm(confirmMessage)) {
                    DataStorage.deleteCategory(id);
                    
                    // 如果当前筛选的是被删除的分类，切换到全部
                    if (this.currentCategory === id) {
                        this.currentCategory = 'all';
                    }
                    
                    this.renderCategories();
                    this.renderMemos();
                    this.showToast('分类已删除');
                }
            }

            // 渲染备忘录列表
            renderMemos() {
                console.log('渲染备忘录列表');
                const memos = DataStorage.getMemos();
                const categories = DataStorage.getCategories();
                
                // 筛选备忘录
                let filteredMemos = memos;
                
                // 按分类筛选
                if (this.currentCategory === 'all') {
                    // 不筛选，显示全部
                } else if (this.currentCategory === 'uncategorized') {
                    filteredMemos = filteredMemos.filter(memo => !memo.categoryId);
                } else {
                    filteredMemos = filteredMemos.filter(memo => memo.categoryId === this.currentCategory);
                }
                
                // 按搜索词筛选
                if (this.searchTerm) {
                    filteredMemos = filteredMemos.filter(memo => 
                        memo.title.toLowerCase().includes(this.searchTerm) || 
                        memo.content.toLowerCase().includes(this.searchTerm)
                    );
                }
                
                // 按创建时间排序（最新的在前）
                filteredMemos.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // 清空列表
                this.elements.memoList.innerHTML = '';
                
                // 没有备忘录时显示提示
                if (filteredMemos.length === 0) {
                    this.elements.memoList.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-16 text-neutral-500">
                            <i class="fa fa-search text-6xl mb-4 opacity-30"></i>
                            <p class="text-xl mb-2">没有找到记录</p>
                            <p class="text-center max-w-md">尝试更改筛选条件或搜索词</p>
                        </div>
                    `;
                    return;
                }
                
                // 渲染备忘录
                filteredMemos.forEach(memo => {
                    const memoElement = this.createMemoElement(memo, categories);
                    this.elements.memoList.appendChild(memoElement);
                });
                
                // 恢复选择状态
                this.updateMemoSelectionUI();
                
                // 更新统计
                this.updateStats();
            }

            // 创建备忘录元素
            createMemoElement(memo, categories) {
                const div = document.createElement('div');
                // 检查是否被选中
                const isSelected = this.selectedMemos.has(memo.id);
                div.className = `bg-white rounded-xl p-5 memo-shadow memo-hover border border-neutral-100 ${memo.completed ? 'opacity-70' : ''} ${isSelected ? 'memo-selected' : ''} relative`;
                div.dataset.id = memo.id;
                
                // 格式化日期
                const date = new Date(memo.createdAt);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                
                // 获取分类信息
                let category = categories.find(cat => cat.id === memo.categoryId);
                let categoryIcon = 'fa-question-circle';
                let categoryColor = 'bg-gray-100 text-gray-600';
                let categoryName = '未分类';
                
                if (category) {
                    categoryIcon = category.icon;
                    categoryColor = category.colorClass;
                    categoryName = category.name;
                }
                
                // 密码内容默认隐藏（如果是密码分类）
                let contentDisplay = memo.content;
                let showHideBtn = '';
                if (category && category.name === '账号密码') {
                    contentDisplay = '••••••••';
                    showHideBtn = `
                        <button class="show-hide-btn ml-2 text-xs text-primary hover:text-primary/80">
                            显示
                        </button>
                    `;
                }
                
                // 完成状态文本
                let completedBadge = '';
                if (memo.completed) {
                    completedBadge = `
                        <span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">
                            已完成
                        </span>
                    `;
                }
                
                // 选择状态指示
                const selectionIndicator = isSelected ? `
                    <span class="absolute top-3 left-3 w-5 h-5 rounded-full bg-primary text-white flex items-center justify-center text-xs">
                        <i class="fa fa-check"></i>
                    </span>
                ` : '';
                
                div.innerHTML = `
                    ${selectionIndicator}
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center flex-wrap">
                            <span class="w-6 h-6 rounded-full ${categoryColor} flex items-center justify-center text-xs mr-2">
                                <i class="fa ${categoryIcon}"></i>
                            </span>
                            <h3 class="font-bold text-lg ${memo.completed ? 'line-through text-neutral-500' : ''}">${memo.title}</h3>
                            ${completedBadge}
                        </div>
                        <div class="flex items-center">
                            <input 
                                type="checkbox" 
                                class="complete-checkbox w-4 h-4 text-primary border-neutral-300 rounded focus:ring-primary"
                                ${memo.completed ? 'checked' : ''}
                            >
                        </div>
                    </div>
                    
                    <p class="text-neutral-600 text-sm mb-4 line-clamp-3 password-content ${category && category.name === '账号密码' ? 'password-masked' : ''}">${contentDisplay}</p>
                    
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="text-xs text-neutral-500">${formattedDate}</span>
                            <span class="text-xs text-neutral-400 ml-2">${categoryName}</span>
                            ${showHideBtn}
                        </div>
                        <div class="flex gap-1">
                            <button class="edit-btn p-1.5 text-neutral-500 hover:text-primary rounded-full hover:bg-primary/10 transition-colors">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <!-- 删除按钮 - 确保ID正确设置 -->
                            <button class="memo-delete-btn rounded-full text-neutral-500" data-memo-id="${memo.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                return div;
            }

            // 打开备忘录模态框
            openModal(memoId = null) {
                console.log('打开备忘录模态框，ID:', memoId);
                // 重置表单
                this.elements.memoForm.reset();
                this.elements.memoId.value = '';
                this.elements.modalTitle.textContent = '新增记录';
                
                // 如果是编辑模式，填充表单
                if (memoId) {
                    const memos = DataStorage.getMemos();
                    const memo = memos.find(m => m.id === memoId);
                    
                    if (memo) {
                        this.elements.memoId.value = memo.id;
                        this.elements.memoTitleInput.value = memo.title;
                        this.elements.memoContent.value = memo.content;
                        this.elements.memoCategory.value = memo.categoryId || '';
                        this.elements.memoCompleted.checked = memo.completed;
                        this.elements.modalTitle.textContent = '编辑记录';
                    }
                }
                
                // 显示模态框
                this.elements.memoModal.classList.remove('opacity-0', 'pointer-events-none');
                this.elements.modalContent.classList.remove('scale-95');
                this.elements.modalContent.classList.add('scale-100');
                this.elements.memoTitleInput.focus();
            }

            // 关闭备忘录模态框
            closeModalFunc() {
                console.log('关闭备忘录模态框');
                this.elements.memoModal.classList.add('opacity-0', 'pointer-events-none');
                this.elements.modalContent.classList.remove('scale-100');
                this.elements.modalContent.classList.add('scale-95');
            }

            // 保存备忘录
            saveMemo() {
                console.log('保存备忘录');
                const id = this.elements.memoId.value;
                const title = this.elements.memoTitleInput.value;
                const content = this.elements.memoContent.value;
                const categoryId = this.elements.memoCategory.value || null;
                const completed = this.elements.memoCompleted.checked;
                
                if (!title.trim()) {
                    this.showToast('请输入标题', 'error');
                    return;
                }
                
                // 创建或更新备忘录
                const memo = new Memo(id, title, content, categoryId, completed, id ? DataStorage.getMemos().find(m => m.id === id)?.createdAt : null);
                DataStorage.saveMemo(memo);
                
                // 关闭模态框并重新渲染
                this.closeModalFunc();
                this.renderMemos();
                this.renderCategories(); // 可能需要更新分类计数
                
                // 显示提示
                this.showToast(id ? '记录已更新' : '记录已保存');
            }

            // 删除备忘录
            deleteMemo(id) {
                console.log('执行删除备忘录，ID:', id);
                if (!id) {
                    console.error('删除失败：没有找到备忘录ID');
                    this.showToast('删除失败：未找到记录', 'error');
                    return;
                }
                
                // 确认删除
                if (confirm('确定要删除这条记录吗？此操作不可撤销。')) {
                    try {
                        // 调用数据存储层删除
                        const updatedMemos = DataStorage.deleteMemo(id);
                        console.log('删除后剩余记录数:', updatedMemos.length);
                        
                        // 如果删除的是选中的备忘录，从选择集中移除
                        if (this.selectedMemos.has(id)) {
                            this.selectedMemos.delete(id);
                            this.updateBatchActionsVisibility();
                        }
                        
                        // 重新渲染列表
                        this.renderMemos();
                        this.renderCategories(); // 更新分类计数
                        
                        this.showToast('记录已成功删除');
                    } catch (error) {
                        console.error('删除失败:', error);
                        this.showToast('删除失败，请重试', 'error');
                    }
                }
            }

            // 切换备忘录完成状态
            toggleComplete(id, completed) {
                console.log('切换备忘录完成状态，ID:', id, '完成:', completed);
                const memos = DataStorage.getMemos();
                const memo = memos.find(m => m.id === id);
                
                if (memo) {
                    memo.completed = completed;
                    DataStorage.saveMemo(memo);
                    this.renderMemos();
                }
            }

            // 打开分类管理模态框
            openCategoryModal() {
                console.log('打开分类管理模态框');
                this.elements.categoryModal.classList.remove('opacity-0', 'pointer-events-none');
                this.elements.categoryModalContent.classList.remove('scale-95');
                this.elements.categoryModalContent.classList.add('scale-100');
                this.elements.newCategoryName.focus();
            }

            // 关闭分类管理模态框
            closeCategoryModalFunc() {
                console.log('关闭分类管理模态框');
                this.elements.categoryModal.classList.add('opacity-0', 'pointer-events-none');
                this.elements.categoryModalContent.classList.remove('scale-100');
                this.elements.categoryModalContent.classList.add('scale-95');
            }

            // 更新统计数据
            updateStats() {
                console.log('更新统计数据');
                const pendingMemos = DataStorage.getPendingMemosCount();
                this.elements.pendingMemos.textContent = pendingMemos;
            }

            // 显示提示消息
            showToast(message, type = 'success') {
                console.log('显示提示:', message);
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-y-10 opacity-0 transition-all duration-500`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.remove('translate-y-10', 'opacity-0');
                }, 10);
                
                setTimeout(() => {
                    toast.classList.add('translate-y-10', 'opacity-0');
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 500);
                }, 2000);
            }
        }

        // 初始化应用
        window.addEventListener('load', () => {
            console.log('页面加载完成，初始化应用');
            
            // 添加一些示例数据（如果没有数据的话）
            if (DataStorage.getMemos().length === 0) {
                const categories = DataStorage.getCategories();
                const passwordCategory = categories.find(c => c.name === '账号密码');
                const movieCategory = categories.find(c => c.name === '影视娱乐');
                const bookCategory = categories.find(c => c.name === '阅读清单');
                const lifeCategory = categories.find(c => c.name === '生活琐事');
                
                const sampleMemos = [
                    new Memo(null, '豆瓣账号', '账号：mydouban@example.com，密码：D0uB@n12345', passwordCategory?.id, false),
                    new Memo(null, '肖申克的救赎', '评分很高的一部电影，讲述银行家被冤枉入狱后的故事', movieCategory?.id, false),
                    new Memo(null, '人类简史', '尤瓦尔·赫拉利的著作，从认知革命、农业革命到科学革命', bookCategory?.id, false),
                    new Memo(null, '冰箱清理', '周末需要彻底清理冰箱，扔掉过期食品', lifeCategory?.id, false),
                    new Memo(null, '未分类示例', '这是一条未分类的记录', null, false)
                ];
                
                sampleMemos.forEach(memo => DataStorage.saveMemo(memo));
            }
            
            // 启动应用
            app = new MemoUI();
        });
    </script>
</body>
</html>
    